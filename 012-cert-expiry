#!/bin/bash
# Upcoming certificate expirations (uses cached data)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cache-helpers.sh"

# Try cache first (valid for 6 hours = 21600 seconds)
if cached=$(read_cache "cert-expiry" 21600); then
    [[ -z "$cached" ]] && exit 0
    
    printf "\033[1müîê Certificate Expirations:\033[0m\n"
    while IFS=: read -r cert_name days_until; do
        [[ -z "$cert_name" ]] && continue
        if [[ $days_until -lt 0 ]]; then
            printf "  \033[1;31m%s - EXPIRED\033[0m\n" "$cert_name"
        elif [[ $days_until -lt 7 ]]; then
            printf "  \033[1;31m%s - %d days\033[0m\n" "$cert_name" "$days_until"
        else
            printf "  \033[1;33m%s - %d days\033[0m\n" "$cert_name" "$days_until"
        fi
    done <<< "$cached"
else
    # Fallback: compute live (original logic)
    found_certs=0
    cert_paths=("/etc/ssl/certs" "/home/pi/.ssh" "/etc/letsencrypt/live")
    
    for cert_path in "${cert_paths[@]}"; do
        [[ ! -d "$cert_path" ]] && continue
        while IFS= read -r cert_file; do
            expiry=$(openssl x509 -enddate -noout -in "$cert_file" 2>/dev/null | cut -d= -f2)
            [[ -z "$expiry" ]] && continue
            
            expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null)
            now_epoch=$(date +%s)
            days_until=$((($expiry_epoch - $now_epoch) / 86400))
            
            if [[ $days_until -lt 30 ]]; then
                [[ $found_certs -eq 0 ]] && printf "\033[1müîê Certificate Expirations:\033[0m\n" && found_certs=1
                if [[ $days_until -lt 0 ]]; then
                    printf "  \033[1;31m$(basename $cert_file) - EXPIRED\033[0m\n"
                elif [[ $days_until -lt 7 ]]; then
                    printf "  \033[1;31m$(basename $cert_file) - %d days\033[0m\n" "$days_until"
                else
                    printf "  \033[1;33m$(basename $cert_file) - %d days\033[0m\n" "$days_until"
                fi
            fi
        done < <(find "$cert_path" -maxdepth 2 -type f \( -name "*.pem" -o -name "*.crt" -o -name "*.cert" \) 2>/dev/null)
    done
fi
