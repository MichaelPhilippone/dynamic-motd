#!/bin/bash
# Upcoming certificate expirations

found_certs=0

# Check common certificate locations
cert_paths=(
    "/etc/ssl/certs"
    "/home/pi/.ssh"
    "/etc/letsencrypt/live"
)

for cert_path in "${cert_paths[@]}"; do
    [[ ! -d "$cert_path" ]] && continue
    
    while IFS= read -r cert_file; do
        expiry=$(openssl x509 -enddate -noout -in "$cert_file" 2>/dev/null | cut -d= -f2)
        if [[ -z "$expiry" ]]; then
            continue
        fi
        
        expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null)
        now_epoch=$(date +%s)
        days_until=$((($expiry_epoch - $now_epoch) / 86400))
        
        if [[ $days_until -lt 30 ]]; then
            if [[ $found_certs -eq 0 ]]; then
                printf "\033[1müîê Certificate Expirations:\033[0m\n"
                found_certs=1
            fi
            
            if [[ $days_until -lt 0 ]]; then
                printf "  \033[1;31m$(basename $cert_file) - EXPIRED\033[0m\n"
            elif [[ $days_until -lt 7 ]]; then
                printf "  \033[1;31m$(basename $cert_file) - %d days\033[0m\n" "$days_until"
            else
                printf "  \033[1;33m$(basename $cert_file) - %d days\033[0m\n" "$days_until"
            fi
        fi
    done < <(find "$cert_path" -maxdepth 2 -type f \( -name "*.pem" -o -name "*.crt" -o -name "*.cert" \) 2>/dev/null)
done
