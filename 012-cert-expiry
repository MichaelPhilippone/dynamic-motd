#!/bin/bash
# Certificate expiration status (uses cached data)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cache-helpers.sh"

CACHE_KEY="cert-expiry"
from_cache=false

# Try cache first (valid for 6 hours = 21600 seconds)
if cached=$(read_cache "$CACHE_KEY" 21600); then
    from_cache=true
    if [[ -z "$cached" || "$cached" == "none" ]]; then
        exit 0
    fi
else
    # Fallback: compute live
    cached=""
    cert_dirs=("/etc/letsencrypt/live" "$HOME/.acme.sh")
    
    for cert_dir in "${cert_dirs[@]}"; do
        [[ ! -d "$cert_dir" ]] && continue
        
        for cert in "$cert_dir"/*/; do
            [[ ! -d "$cert" ]] && continue
            
            cert_name=$(basename "$cert")
            cert_file=""
            
            # Find the cert file
            if [[ -f "$cert/fullchain.pem" ]]; then
                cert_file="$cert/fullchain.pem"
            elif [[ -f "$cert/cert.pem" ]]; then
                cert_file="$cert/cert.pem"
            elif [[ -f "$cert/${cert_name}.cer" ]]; then
                cert_file="$cert/${cert_name}.cer"
            fi
            
            [[ -z "$cert_file" ]] && continue
            
            # Get expiry date
            expiry=$(openssl x509 -enddate -noout -in "$cert_file" 2>/dev/null | cut -d= -f2)
            [[ -z "$expiry" ]] && continue
            
            expiry_epoch=$(date -d "$expiry" +%s 2>/dev/null)
            now_epoch=$(date +%s)
            days_until=$(( (expiry_epoch - now_epoch) / 86400 ))
            
            cached+="$cert_name:$days_until"$'\n'
        done
    done
    
    if [[ -z "$cached" ]]; then
        exit 0
    fi
fi

cache_suffix=""
if $from_cache; then
    cache_suffix=" \033[90m(cached $(cache_age_str "$CACHE_KEY"))\033[0m"
fi

printf "\033[1müîê Certificate Expirations:\033[0m$cache_suffix\n"

echo "$cached" | while IFS=: read -r cert_name days_until; do
    [[ -z "$cert_name" ]] && continue
    
    if [[ $days_until -lt 0 ]]; then
        printf "  \033[1;31m‚úó %-30s EXPIRED\033[0m\n" "$cert_name"
    elif [[ $days_until -lt 7 ]]; then
        printf "  \033[1;31m‚ö† %-30s %d days\033[0m\n" "$cert_name" "$days_until"
    elif [[ $days_until -lt 30 ]]; then
        printf "  \033[1;33m‚ö† %-30s %d days\033[0m\n" "$cert_name" "$days_until"
    else
        printf "  \033[32m‚úì %-30s %d days\033[0m\n" "$cert_name" "$days_until"
    fi
done
