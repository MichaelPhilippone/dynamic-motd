#!/bin/bash
# Git repos needing attention (uses cached data)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cache-helpers.sh"

CACHE_KEY="git-repos"
from_cache=false

# Try cache first (valid for 10 minutes = 600 seconds)
if cached=$(read_cache "$CACHE_KEY" 600); then
    from_cache=true
    if [[ -z "$cached" || "$cached" == "none" ]]; then
        exit 0
    fi
else
    # Fallback: compute live (slower)
    cached=""
    repos=("$HOME/Projects"/*/)
    for repo in "${repos[@]}"; do
        [[ ! -d "$repo/.git" ]] && continue
        
        repo_name=$(basename "$repo")
        status=""
        
        # Check for uncommitted changes
        if [[ -n $(git -C "$repo" status --porcelain 2>/dev/null) ]]; then
            status="uncommitted"
        fi
        
        # Check for unpushed commits
        unpushed=$(git -C "$repo" log --oneline @{u}.. 2>/dev/null | wc -l)
        if [[ $unpushed -gt 0 ]]; then
            if [[ -n "$status" ]]; then
                status="$status,$unpushed"
            else
                status="clean,$unpushed"
            fi
        fi
        
        if [[ -n "$status" ]]; then
            cached+="$repo_name:$status"$'\n'
        fi
    done
    
    if [[ -z "$cached" ]]; then
        exit 0
    fi
fi

cache_suffix=""
if $from_cache; then
    cache_suffix=" \033[90m(cached $(cache_age_str "$CACHE_KEY"))\033[0m"
fi

printf "\033[1mðŸ“¦ Git Repos Needing Attention:\033[0m$cache_suffix\n"

echo "$cached" | while IFS=: read -r repo_name status; do
    [[ -z "$repo_name" ]] && continue
    
    uncommitted=$(echo "$status" | cut -d, -f1)
    unpushed=$(echo "$status" | cut -d, -f2 -s)
    
    if [[ "$uncommitted" == "uncommitted" ]]; then
        printf "  \033[33mâš¡ %-40s Uncommitted changes\033[0m\n" "$repo_name"
    fi
    
    if [[ -n "$unpushed" && "$unpushed" -gt 0 ]]; then
        printf "  \033[36mâ¬† %-40s %d unpushed commits\033[0m\n" "$repo_name" "$unpushed"
    fi
done
