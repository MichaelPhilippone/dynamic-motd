#!/bin/bash
# Docker/container status (uses cached data)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cache-helpers.sh"

# Try cache first (valid for 5 minutes = 300 seconds)
if cached=$(read_cache "docker-status" 300); then
    if [[ "$cached" == "none" ]]; then
        exit 0
    elif [[ "$cached" == "daemon-down" ]]; then
        printf "\033[1;31mâœ— Docker daemon not running\033[0m\n"
        exit 0
    fi
    running=$(echo "$cached" | cut -d: -f1)
    total=$(echo "$cached" | cut -d: -f2)
else
    # Fallback: compute live
    if ! command -v docker &>/dev/null; then
        exit 0
    fi
    if ! docker info &>/dev/null; then
        printf "\033[1;31mâœ— Docker daemon not running\033[0m\n"
        exit 0
    fi
    running=$(docker ps -q 2>/dev/null | wc -l)
    total=$(docker ps -a -q 2>/dev/null | wc -l)
fi

if [[ $total -eq 0 ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m No containers\n"
elif [[ $running -eq 0 ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m \033[90m%d containers (all stopped)\033[0m\n" "$total"
elif [[ $running -eq $total ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m \033[32m%d containers (all running)\033[0m\n" "$running"
else
    printf "\033[1mğŸ³ Docker:\033[0m \033[33m%d running / %d total\033[0m\n" "$running" "$total"
fi
