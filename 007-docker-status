#!/bin/bash
# Docker/container status (uses cached data)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cache-helpers.sh"

CACHE_KEY="docker-status"
from_cache=false

# Try cache first (valid for 5 minutes = 300 seconds)
if cached=$(read_cache "$CACHE_KEY" 300); then
    from_cache=true
    if [[ "$cached" == "none" ]]; then
        exit 0
    elif [[ "$cached" == "daemon-down" ]]; then
        printf "\033[1;31mâœ— Docker daemon not running\033[0m"
        printf " \033[90m(cached %s)\033[0m\n" "$(cache_age_str "$CACHE_KEY")"
        exit 0
    fi
    running=$(echo "$cached" | cut -d: -f1)
    total=$(echo "$cached" | cut -d: -f2)
else
    # Fallback: compute live
    if ! command -v docker &>/dev/null; then
        exit 0
    fi
    if ! docker info &>/dev/null; then
        printf "\033[1;31mâœ— Docker daemon not running\033[0m\n"
        exit 0
    fi
    running=$(docker ps -q 2>/dev/null | wc -l)
    total=$(docker ps -a -q 2>/dev/null | wc -l)
fi

cache_suffix=""
if $from_cache; then
    cache_suffix=" \033[90m(cached $(cache_age_str "$CACHE_KEY"))\033[0m"
fi

if [[ $total -eq 0 ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m No containers$cache_suffix\n"
elif [[ $running -eq 0 ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m \033[90m%d containers (all stopped)\033[0m$cache_suffix\n" "$total"
elif [[ $running -eq $total ]]; then
    printf "\033[1mğŸ³ Docker:\033[0m \033[32m%d containers (all running)\033[0m$cache_suffix\n" "$running"
else
    printf "\033[1mğŸ³ Docker:\033[0m \033[33m%d running / %d total\033[0m$cache_suffix\n" "$running" "$total"
fi
